<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" type="text/css" href="/bootstrap/css/bootstrap.css"/>
    <link rel="stylesheet" type="text/css" href="/bootstrap/css/bootstrap-table.min.css"/>
    <script src="/LoginRegister/js/jquery.js" type="text/javascript"></script>
    <script src="/bootstrap/js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="/bootstrap/js/bootstrap-table.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="/bootstrap/js/bootstrap-table-zh-CN.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="/bootstrap/js/sweetalert.min.js" type="text/javascript" charset="utf-8"></script>

    <!--bootstrap fileinput插件-->
    <link rel="stylesheet" type="text/css" href="/bootstrap/css/fileinput.min.css"/>
    <script src="/bootstrap/js/fileinput.js" type="text/javascript" charset="utf-8"></script>
    <script src="/bootstrap/js/zh.js" type="text/javascript" charset="utf-8"></script>

    <!--bootstrap 日期插件-->
    <script src="/bootstrap/js/bootstrap-datetimepicker.js" type="text/javascript" charset="utf-8"></script>
    <link rel="stylesheet" type="text/css" href="/bootstrap/css/bootstrap-datetimepicker.css"/>
    <script src="/bootstrap/js/bootstrap-datetimepicker.zh-CN.js" type="text/javascript" charset="utf-8"></script>

    <style>
        #bread { margin-top: 5px;}
        thead tr .th-inner {text-align: center;}
    </style>

    <script>
        $(function () {

            $('#Showtime').datetimepicker({
                forceParse: 0, //设置为0，时间不会跳转为1899
                language: 'zh-CN' , //显示中文
                format: 'yyyy-mm-dd', //显示格式
                minView: "month", //显示到月份
                initialDate: new Date(), //初始化当前的日期
                autoclose: true, //选中自动关闭
                todayBtn: true //显示当日按钮
            });

            $('#table').bootstrapTable({
                url:"/movie/findallmovie2",
                method: 'post',             //请求方式（*）
                locale: "zh-CN",            // 语言
                dataType:"json",
                contentType: "application/x-www-form-urlencoded",
                toolbar: "#toolbar",        // 工具栏
                search: true,              // 显示搜索
                showColumns: false,         //隐藏列
                striped: true,              // 是否显示行间隔色
                showRefresh: true,         // 是否显示刷新按钮
                clickToSelect: false,       // 是否启用点击选中行
                pageList: [3, 4, 5],        //可供选择的每页的行数（*）
                showToggle: false,          // 是否显示详细视图和列表视图的切换按钮
                sortable: true,            // 是否启用排序
                sortOrder: "asc",           // 排序方式
                pagination: true,           // 是否显示分页
                pageSize: "3",              // 每页显示的行数
                pageNumber:"1",               //当前第几页
                sidePagination: "client",   // 分页方式：client客户端分页，server服务端分页
                columns: [
                    { field: 'movieid', title: '电影编号'},
                    {
                        field: 'movieprc',
                        title: '电影封面',
                        formatter: function (value,row,index) {
                            var result = "";

                            if (value == "") {
                                result = "<span style='color: orangered;'>未上传图片</spansty>";
                            } else {
                                result = "<img src='/prc/movieprc/"+value+".jpg' alt='找不到图片' style='width: 68px;100px;'/>";
                            }
                            return result;
                        }
                    },
                    { field: 'moviename', title: '电影名称'},
                    { field: 'director', title: '导演'},
                    { field: 'language', title: '语言'},
                    { field: 'showtime', title: '上映时间'},
                    { field: 'duration', title: '时长(分钟)'},
                    { field: 'actor', title: '主演'},
                    { field: 'briefintro', title: '简介'},
                    {
                        field: 'operate',
                        title: '操作',
                        align: 'center',
                        valign: 'middle',
                        events: {
                            'click #moviemodify': function (e, value, row, index) {
                                moviemodify(row.movieid);
                            },
                            'click #moviedel': function (e, value, row, index) {
                                moviedel(row.movieid);
                            },
                            'click #movieprcupoload': function (e, value, row, index) {
                                movieprcSumit(row.movieid);
                            }
                        },
                        formatter: function (value, row, index) {
                            var result = "";
                            result += '<button id="moviemodify" class="btn btn-info" data-toggle="modal" data-target="#editModal">修改</button><br/><br/>';
                            result += '<button id="moviedel" class="btn btn-danger" data-toggle="modal" data-target="#delModal">删除</button><br/><br/>';
                            result += '<button id="movieprcupoload" class="btn btn-success" data-toggle="modal" data-target="#prcModal">上传图片</button>';
                            return result;
                        }
                    }
                ]
            });


            /*修改电影*/
            function moviemodify(movieid) {
                /*显示电影id*/
                $('#Movieid').val('movie'+movieid);

                $('#btn_submit').click(function () {
                    var moviename = $('#Moviename').val();
                    var director = $('#Director').val();
                    var language = $('#Language').val();
                    var showtime = $('#Showtime').val();
                    var duration = $('#Duration').val();
                    var actor = $('#Actor').val();
                    var briefintro = $('#Briefintro').val();

                    $.ajax({
                        url: "/movie/updatemovie",
                        type:"post",
                        data: {
                            "movieid":movieid,
                            "moviename":moviename,
                            "director":director,
                            "language":language,
                            "showtime":showtime,
                            "duration":duration,
                            "actor":actor,
                            "briefintro":briefintro
                        },
                        async:false,
                        success: function (data) {
                            if (data == "操作成功") {
                                swal({
                                    title: "提示",
                                    text: "修改信息成功",
                                    icon: "success",
                                    showConfirmButton: true
                                });
                                $('#table').bootstrapTable('refresh');
                            } else {
                                swal({
                                    title: "提示",
                                    text: "修改信息失败",
                                    icon: "error",
                                    showConfirmButton: true
                                });
                            }
                        }
                    });
                    //移出掉this的click事件
                    $('#btn_submit').off('click');
                });
            }


            /*删除电影*/
            function moviedel(movieid){

                $('#btn_submit1').click(function () {
                    $.ajax({
                        url: "/movie/delmovie",
                        type:"post",
                        data:{
                            "movieid": movieid
                        },
                        async:false,
                        success: function (data) {
                            if (data == "操作成功") {
                                swal({
                                    title: "提示",
                                    text: "成功删除电影",
                                    icon: "success",
                                    showConfirmButton: true
                                });

                                $('#table').bootstrapTable('refresh');
                            } else {
                                swal({
                                    title: "提示",
                                    text: "删除电影失败",
                                    icon: "error",
                                    showConfirmButton: true
                                });
                            }
                        }
                    });
                    //移出掉this的click事件
                    $(this).off('click');
                });
            }


            /*设置图片*/
            function movieprcSumit(movieid) {
                //实现文件上传
                $("#uploadfile").fileinput({
                    language: 'zh', //设置语言
                    uploadUrl: "/movie/upmovieprc?movieid="+movieid, //上传的地址
                    allowedFileExtensions: ['jpg'],//接收的文件后缀
                    uploadAsync: false, //默认异步上传
                    showUpload: true, //是否显示上传按钮
                    showRemove : false, //显示移除按钮
                    browseClass: "btn btn-primary", //按钮样式
                    maxFileCount: 1, //表示允许同时上传的最大文件个数
                    previewFileIcon: "<i class='glyphicon glyphicon-king'></i>",
                    slugCallback: function (filename) {
                        return filename.replace('(', '_').replace(']', '_');
                    }
                });

            }

        });
    </script>

</head>

<body>

<div id="mainbody">

    <!--面包屑导航开始-->
    <ul class="breadcrumb" id="bread">当前位置：
        <li>后台管理</li>
        <li>电影管理</li>
        <li>电影操作</li>
    </ul>

    <!--表格-->
    <div style="text-align: center;">
        <div id="toolbar"></div>
        <table id="table"  style="text-align: center;"></table>
    </div>
    <!--表格结束-->

    <!--模态框 修改 开始-->
    <div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">

                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">电影信息修改</h4>
                </div>

                <div class="modal-body">
                    <div class="form-group">
                        <label for="Movieid">电影编号</label>
                        <input type="text" name="Movieid" readonly="readonly" class="form-control" id="Movieid"/>
                    </div>
                    <div class="form-group">
                        <label for="Moviename">电影名称</label>
                        <input type="text" name="Moviename" class="form-control" id="Moviename"/>
                    </div>
                    <div class="form-group">
                        <label for="Director">导演</label>
                        <input type="text" name="Director" class="form-control" id="Director"/>
                    </div>
                    <div class="form-group">
                        <label for="Language">语言</label>
                        <input type="text" name="Language" class="form-control" id="Language"/>
                    </div>
                    <div class="form-group">
                        <label for="Showtime">上映时间</label>
                        <input type="text" name="Showtime" class="form-control" id="Showtime"/>
                    </div>
                    <div class="form-group">
                        <label for="Duration">电影时长(分钟)</label>
                        <input type="text" name="Duration" class="form-control" id="Duration"/>
                    </div>
                    <div class="form-group">
                        <label for="Actor">主演</label>
                        <input type="text" name="Actor" class="form-control" id="Actor"/>
                    </div>
                    <div class="form-group">
                        <label for="Briefintro">简介</label>
                        <textarea id="Briefintro" class="form-control" name="Briefintro" rows="4"></textarea>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span>关闭</button>
                    <button type="button" id="btn_submit" class="btn btn-primary" data-dismiss="modal"><span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"></span>修改</button>
                </div>

            </div>
        </div>
    </div>
    <!--模态框 修改 结束-->


    <!--删除的模态框 开始-->
    <div class="modal fade" id="delModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">

                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel1">删除电影</h4>
                </div>

                <div class="modal-body">
                    <p><span style="color: red;">确定删除该电影？</span></p>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span>关闭</button>
                    <button type="button" id="btn_submit1" class="btn btn-primary" data-dismiss="modal"><span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"></span>删除</button>
                </div>

            </div>
        </div>
    </div>
    <!--删除的模态框 结束-->



    <!--模态框 图片上传 开始-->
    <div class="modal fade" id="prcModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">

                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel2">电影封面上传</h4>
                </div>

                <div class="modal-body">
                    <input type="file" name="file" id="uploadfile"/>
                </div>

            </div>
        </div>
    </div>
    <!--模态框 图片上传 结束-->

</div>


</body>
</html>