<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>活动详情</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width">

    <!-- Bootstrap styles -->
    <link rel="stylesheet" href="/bootstrap/css/bootstrap.css">

    <!-- Font-Awesome -->
    <link rel="stylesheet" href="/bootstrap/font-awesome/css/font-awesome.min.css">

    <!-- Google Webfonts -->
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,600|PT+Serif:400,400italic' rel='stylesheet' type='text/css'>

    <!-- Styles -->
    <link rel="stylesheet" href="/bootstrap/css/style.css" id="theme-styles">


</head>
<body>
<header>
    <div class="widewrapper masthead">
        <div class="container">
            <a href="" id="logo">
                <span style="color: #3c485d; font-size: 30px;">校园课外娱乐网</span>
            </a>

            <nav class="pull-right">
                <div class="collapse navbar-collapse">
                    <ul class="nav nav-pills navbar-nav">
                        <li>
                            <a href="/user/index">首页</a>
                        </li>
                        <li>
                            <a href="/user/bookhome">读书</a>
                        </li>
                        <li>
                            <a href="/user/moviehome">电影</a>
                        </li>
                        <li>
                            <a href="/user/musichome">音乐</a>
                        </li>
                        <li>
                            <a href="/user/activityhome">户外活动</a>
                        </li>
                        <li>
                            <a href="/user/userinfohome">个人管理</a>
                        </li>
                    </ul>
                </div>
            </nav>

        </div>
    </div>

    <div class="widewrapper subheader">
        <div class="container">

            <!--面包屑导航-->
            <div class="clean-breadcrumb">
                <a href="/user/index">首页</a>
                <span class="separator">&#x2F;</span>
                <a href="/user/activityhome">户外活动</a>
                <span class="separator">&#x2F;</span>
                <a href=""><span th:text="${activityEntity.activityname}"></span></a>
            </div>

            <!--搜索-->
            <div class="clean-searchbox">
                <div accept-charset="utf-8">
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <button class="searchbutton" id="searchbtn">
                        <i class="fa fa-search"></i>&nbsp;&nbsp;&nbsp;&nbsp;图书 音乐 电影
                    </button>
                </div>
            </div>
        </div>
    </div>
</header>

<div class="widewrapper main">
    <div class="container">

        <div class="row">
            <div class="col-md-8 blog-main">

                <div class="page-header">
                    <h4><span th:text="${activityEntity.activityname}"></span></h4>
                </div>

                <!--活动详情-->
                <div id="bookinfo">
                    <table class="bookinfo">
                        <tr>
                            <td rowspan ="2">
                                <img th:src="|/prc/activityprc/${activityEntity.activityprc}.jpg|" height="200" width="200"/>
                            </td>
                            <td>
                                <ul style="list-style-type: none;">
                                    <li>活动名称：<span th:text="${activityEntity.activityname}"></span></li>
                                    <li>活动发起者：<span th:text="${nickname}"></span></li>
                                    <li>活动地点：<span th:text="${activityEntity.activityplace}"></span></li>
                                    <li>截至日期：<span th:text="${activityEntity.activitydate}"></span></li>
                                    <li>活动天数：<span th:text="|${activityEntity.activitytime} 天|"></span></li>
                                    <li id="showifstop"></li>
                                    <li><span>&nbsp</span></li>
                                </ul>
                            </td>
                        </tr>
                    </table>
                </div>

                <!--简介-->
                <div id="bookjianjie">
                    <div class="page-header">
                        <h4><span>户外活动介绍</span></h4>
                    </div>
                    <table class="bookinfo">
                        <tr>
                            <td>
                                <p style="text-indent: 2em;"><span th:text="${activityEntity.activityintro}"></span></p>
                            </td>
                        </tr>
                    </table>
                </div>

                <!--评分-->
                <div id="bookpingfen">
                    <div class="page-header">
                        <h4><span>户外活动报名</span></h4>

                    </div>

                    <button id="enbtn" type="button" class="btn btn-default" style="float: right;">报名参加活动</button>
                </div>

                <!--活动随笔区-->
                <div id="pinglun">
                    <div class="page-header">
                        <h4><span>活动随笔</span></h4>
                    </div>
                    <div class="row" id="showcomment"></div>
                </div>

                <div class="paging">
                    <ul id="pageButton"></ul>

                    <br/>

                    <aside class="create-comment" id="create-comment">
                        <hr>
                        <div>
                            <textarea rows="10"  id="comment" placeholder="只有参与的人才可以成功评论" class="form-control input-lg"></textarea>

                            <div class="buttons clearfix">
                                <button type="submit" id="submitComment" class="btn btn-default">提交活动随笔</button>
                            </div>
                        </div>
                    </aside>

                    <a href="#" class="older">返回顶部</i></a>
                </div>
            </div>


            <!--右边-->
            <aside class="col-md-4 blog-aside">

                <div class="aside-widget">
                    <header>
                        <h3>用户</h3>
                    </header>
                    <div class="body" id="showuserinfo">

                    </div>
                </div>

                <div class="aside-widget">
                    <header>
                        <h3>我的</h3>
                    </header>
                    <div class="body">
                        <ul>
                            <li><button type="button" class="btn btn-default" id="myactivity">我发起的活动</button></li>
                            <li><button type="button" class="btn btn-default" id="joinactivity">我参与的活动</button></li>
                        </ul>
                    </div>
                </div>

            </aside>
        </div>
    </div>
</div>

<!--网页底部-->
<footer>
    <div class="widewrapper footer">
        <div class="container">
            <div class="row">
                <div class="col-md-4 footer-widget">
                    <h3> <i class="fa fa-user"></i>关于</h3>

                    <p>这是一个集书籍、电影、音乐和户外活动的四个主题的校园课外娱乐网站，用于丰富学生的课外生活。</p>
                </div>

                <div class="col-md-4 footer-widget">
                    <h3> <i class="fa fa-pencil"></i>校园网站</h3>
                    <ul class="clean-list">
                        <li><a href="https://www.zhku.edu.cn/" target="_blank">仲恺农业工程学院官网</a></li>
                        <li><a href="http://jw.zhku.edu.cn/" target="_blank">仲恺农业工程学院教务网</a></li>
                    </ul>
                </div>

                <div class="col-md-4 footer-widget">
                    <h3> <i class="fa fa-envelope"></i>联系方式</h3>
                    <p>邮箱：2606201863@qq.com</p>
                </div>

            </div>
        </div>
    </div>
</footer>

<script src="/bootstrap/js/jquery.min.js"></script>
<script src="/bootstrap/js/bootstrap.min.js"></script>
<script src="/bootstrap/js/modernizr.js"></script>
<script src="/js/myjs/ifshowuser.js"></script>
<script src="/js/layer/layer.js" type="text/javascript" charset="utf-8"></script>
<script src="/bootstrap/js/bootstrap-paginator.min.js"></script>

<script th:inline="javascript">


    $(function () {

        /*判断报名时间*/
        $.ajax({
            url: "/activityenlist/ifdatestop",
            type: "post",
            data: {
                "activitydate": [[${activityEntity.activitydate}]]
            },
            async:false,
            success: function (data) {
                var htm = "";

                if( data === "可以报名") {
                    htm = `活动状态：<span style="color: #99CC66">可以报名</span>`;
                } else if (data === "报名截止") {
                    htm = `活动状态：<span style="color: red">报名截至</span>`;
                }

                $('#showifstop').html(htm);
            }
        });



        /*提交报名*/
        $('#enbtn').click(function () {
            layer.open({
                title: '户外活动报名',
                type: 1,
                skin: 'layui-layer-rim', //加上边框
                area: ['270px', '270px'], //宽高
                content: '                <div id="form">\n' +
                    '\n' +
                    '                        <div class="form-horizontal">\n' +
                    '\n' +
                    '                            <div class="form-group">\n' +
                    '                                <label for="activityname" class="col-sm-4 control-label">活动名</label>\n' +
                    '                                <div class="col-sm-6">\n' +
                    '                                    <input type="text" class="form-control" readonly="readonly"  id="activityname" name="name" value=' + [[${activityEntity.activityname}]] + '>\n' +
                    '                                </div>\n' +
                    '                            </div>\n' +
                    '\n' +
                    '                            <div class="form-group">\n' +
                    '                                <label for="name" class="col-sm-4 control-label">姓名</label>\n' +
                    '                                <div class="col-sm-6">\n' +
                    '                                    <input type="text" class="form-control"  id="name" name="name"/>\n' +
                    '                                </div>\n' +
                    '                            </div>\n' +
                    '\n' +
                    '                            <div class="form-group">\n' +
                    '                                <label for="phone" class="col-sm-4 control-label">电话</label>\n' +
                    '                                <div class="col-sm-6">\n' +
                    '                                    <input type="text" class="form-control" id="phone" name="phone"/>\n' +
                    '                                </div>\n' +
                    '                            </div>\n' +
                    '\n' +
                    '                            <div class="form-group">\n' +
                    '                                <div class="col-sm-offset-2 col-sm-10">\n' +
                    '                                    <button type="submit" id="submitBtn" class="btn btn-default">提交报名表</button>\n' +
                    '                                </div>\n' +
                    '                            </div>\n' +
                    '\n' +
                    '                        </div>\n' +
                    '\n' +
                    '                    </div>'
            });

        });

        // 初始化页面
        getPageOfMemo(1);

        // 进行报名操作 layui写法
        $(document).on("click",'#submitBtn',function(){

            var name = $('#name').val();
            var phone = $('#phone').val();


            if (name === "" || phone ==="") {
                layer.msg("请填写完整信息");
            } else {

                $.ajax({
                    url: "/activityenlist/submitenlist",
                    type: "post",
                    data: {
                        "phone": phone,
                        "name": name,
                        "activityid": [[${activityEntity.activityid}]],
                        "activitydate": [[${activityEntity.activitydate}]]
                    },
                    async:false,
                    success: function (data) {

                        if (data === "用户未登录") {
                            layer.msg("用户未登录，无权限报名");
                        } else if (data === "该用户已报名") {
                            layer.msg("你已经报名该活动了");
                        } else if (data === "报名成功") {
                            layer.msg("报名成功");
                        } else if (data === "报名时间已过") {
                            layer.msg("报名已截至");
                        }

                    }
                });

            }

        });

        /*提交随笔操作*/
        $('#submitComment').click(function () {

            var essay = $('#comment').val();

            if (essay === "" ) {
                layer.msg("活动随笔不能为空");
            } else {

                var xUrl = "/activityenlist/submitessay";

                $.ajax({
                    url:xUrl,
                    type:"POST",
                    data: {
                        "essay":essay,
                        "activityid":[[${activityEntity.activityid}]]
                    },

                    async:false,
                    success:function (data) {

                        if (data === "用户未登录") {
                            layer.msg("账号未登录，无权限评论");
                        } else if (data === "该用户未报名") {
                            layer.msg("该用户没有报名，无权限评论");
                        } else if(data ==="该用户已经评论过了"){
                            layer.msg("该用户已经提交过随笔了");
                        } else {
                            layer.msg("随笔提交成功，刷新查看");
                        }
                    }
                });


            }

        });



    });

    // 分页函数
    function getPageOfMemo(page) {
        $.ajax({
            url : "/activityenlist/findallessay",
            type : "get",
            data : {
                "activityid" : [[${activityEntity.activityid}]],
                "pageNum" : page, // 初始页
                "pageSize" : 5,
            },
            async: false,
            success : function(data) {
                var totalPages;
                var pageSize = 5;
                if (data != null) {

                    totalPages = (data["commentNum"]+pageSize-1) /pageSize;

                    var htm = "";

                    if (data["essaylist"].length == 0) {
                        htm += `<span>&nbsp;&nbsp;&nbsp;&nbsp;暂无随笔...</span>`;
                    } else {
                        $.each(data["essaylist"], function(i, item) {

                            /*嵌套ajax 获取后台的用户数据*/
                            $.ajax({
                                url: "/comment/finduser",
                                type: "get",
                                data: {
                                    "userid": item.userid
                                },
                                async: false,
                                success: function (data1) {

                                    if (item.essay === "") {
                                        htm += "";
                                    } else {
                                        /*评论界面*/
                                        htm += `
                                        <div class="col-md-12 blog-main" style="border-top: #d0d6d6 1px dashed;border-bottom: #d0d6d6 1px dashed;">
                                            <article class="comment">
                                                <header class="clearfix">
                                                    <img src="/prc/headprc/${data1.headprc}.jpg" alt="找不到图片" class="avatar">&nbsp;&nbsp;&nbsp;&nbsp;
                                                    <span class="date"><span>用户：</span>${data1.nickname}</span>&nbsp;&nbsp;&nbsp;&nbsp;
                                                </header>
                                                <br/>
                                                <div class="body">
                                                    随笔：
                                                    <p style="text-indent: 30px;"><span>${item.essay}</span>
                                                    </p>
                                                </div>
                                            </article>
                                    </div>

                                    `;
                                    }

                                }
                            });

                        });
                    }

                    $('#showcomment').html(htm);

                    var element = $('#pageButton');
                    var options = {
                        bootstrapMajorVersion : 3,
                        currentPage : page, // 当前页数
                        //numberOfPages : 5, // 显示按钮的数量
                        totalPages : totalPages, // 总页数
                        itemTexts : function(type, page, current) {
                            switch (type) {
                                case "first":
                                    return "首页";
                                case "prev":
                                    return "上一页";
                                case "next":
                                    return "下一页";
                                case "last":
                                    return "末页";
                                case "page":
                                    return page;
                            }
                        },
                        // 点击事件，用于通过Ajax来刷新整个list列表
                        onPageClicked : function(event, originalEvent, type, page) {
                            getPageOfMemo(page);
                        }
                    };

                    element.bootstrapPaginator(options);
                }
            }
        });
    };

</script>

</body>
</html>